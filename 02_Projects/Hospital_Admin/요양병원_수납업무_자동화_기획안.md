# 요양병원 수납 업무 자동화 기획안

> 닥터스 CRM 연동 자동화 솔루션  
> 작성일: 2025년 1월 5일

---

## 📋 목차

1. [프로젝트 개요](#1-프로젝트-개요)
2. [전체 워크플로우 구조](#2-전체-워크플로우-구조)
3. [핵심 처리 로직](#3-핵심-처리-로직)
4. [원무일보 최종 구조](#4-원무일보-최종-구조)
5. [필요한 준비사항](#5-필요한-준비사항)
6. [예상 노드 구성 및 복잡도](#6-예상-노드-구성-및-복잡도)
7. [단계별 구현 계획](#7-단계별-구현-계획)
8. [예상 비용](#8-예상-비용)
9. [예상 리스크 및 대응 방안](#9-예상-리스크-및-대응-방안)
10. [다음 단계](#10-다음-단계)

---

## 1. 프로젝트 개요

### 1.1 목표

닥터스 CRM 결제 데이터를 활용한 수납 업무 자동화로 담당자의 **반복 작업을 80% 이상 감소**시킵니다.

### 1.2 자동화 범위

- ✅ 월별 수납여부 명단 자동 생성 (미수금 환자만)
- ✅ 일일 원무일보 자동 작성 (전일 기준)
  - 입원수입 + 외래수입
  - 금액별 수납보고 (당월 통계, 미수금 Aging, 금일 수납액 Aging)
- ✅ 수납여부 실시간 업데이트
- ✅ 발생월 자동 추적 (과거 수납여부 파일 참조)

---

## 2. 전체 워크플로우 구조

### 2.1 월초 워크플로우: 수납여부 생성

**실행 시점:** 매월 1일 오전 9시 (자동) 또는 수동 실행

```
┌─────────────────────────────────────────────────────────┐
│  1. 구글 드라이브에서 닥터스 입원/외래 데이터 읽기       │
│                         ↓                                │
│  2. 전월 수납여부 파일 읽기                              │
│                         ↓                                │
│  3. 현재 미수금 환자 필터링                              │
│     • 닥터스 데이터: 받을금액 > 입금총액/받은금액        │
│     • 전월 수납여부: 수납여부 = "X"인 환자               │
│     • 두 데이터 대조 → 정확한 미수금 명단 생성           │
│                         ↓                                │
│  4. 환자별 미수금 집계                                   │
│                         ↓                                │
│  5. 구글 시트 생성 "수납여부_YYYY년MM월"                 │
│     • 차트번호, 성명, 연락처, 수납액, 수납여부(초기값 X) │
└─────────────────────────────────────────────────────────┘
```

### 2.2 매일 워크플로우: 일일보고서

**실행 시점:** 매일 오후 2시 (자동) - **전일 기준 데이터**

> 💡 예시: 1월 5일 오후 2시 실행 → 1월 4일 결제 데이터로 일보 작성

```
┌──────────────────────────────────────────────────────────┐
│  1. 구글 드라이브에서 닥터스 입원/외래 데이터 읽기        │
│                         ↓                                 │
│  2. 전일 결제 데이터 필터링                               │
│     • 수납일자 = 어제 AND 입금총액/받은금액 > 0           │
│                         ↓                                 │
│  3. 발생월 판단 (과거 수납여부 파일 참조)                 │
│                         ↓                                 │
│  4. 입원수입 테이블 생성                                  │
│     • 환자별 발생월, 결제수단, 금액                       │
│                         ↓                                 │
│  5. 외래수입 테이블 생성                                  │
│     • 성명, 발생월, 진료일자, 계(외래수입)                │
│                         ↓                                 │
│  6. 금액별 수납보고 계산                                  │
│     • 당월 매출 총액, 당월 수납 총액                      │
│     • 수납 총액 파이차트 (수납률)                         │
│     • 미수금 Aging (M, M-1, M-2, M-3)                     │
│     • 금일 수납액 Aging                                   │
│                         ↓                                 │
│  7. 구글 시트 생성 "원무일보_YYYY-MM-DD"                  │
│                         ↓                                 │
│  8. 이번 달 수납여부 시트 업데이트                        │
│     • 어제 결제한 환자 → "O" 표시, 배경색 초록색          │
└──────────────────────────────────────────────────────────┘
```

---

## 3. 핵심 처리 로직

### 3.1 발생월 판단 로직 (핵심)

**문제:** 닥터스 데이터에는 "이 결제가 몇 월 진료비인가?" 정보가 없음  
**해결:** 과거 수납여부 파일과 금액 매칭

#### 알고리즘 예시

```
1. 어제 결제한 환자: 홍길동, 결제액: 1,200,000원

2. 최근 6개월 수납여부 파일 로드
   - 2024년 08월 ~ 2025년 01월

3. 각 파일에서 "홍길동" 검색
   - 12월: 600,000원 발견
   - 11월: 600,000원 발견
   - 10월: 없음

4. 금액 대조
   - 12월 600,000 + 11월 600,000 = 1,200,000 ✅ (일치!)
   
5. 결과
   ➡️ 발생월: "11월,12월"
   ➡️ 내역: "11월,12월 입원"
```

#### 예외 처리

| 케이스 | 처리 방법 |
|--------|-----------|
| **금액 불일치** | 가장 가까운 조합 선택 + "금액 차이 있음" 플래그 |
| **매칭 실패** | 입원일자 기준 추정 (예: 입원일자 2024-10-15 → "10월") |
| **퇴원환자** | 종류 = "퇴원수납" → 입원일자 ~ 퇴원일자 기간으로 추정 |

---

### 3.2 미수금 Aging 계산

**목적:** 장기 미수금 추적 (현재 미수금이 몇 달 전부터 쌓였는지)

#### 계산 로직

```
1. 이번 달 수납여부 파일에서 수납여부 = "X"인 환자 추출
   - 예: 총 18명, 미수금 합계 765,950원

2. 각 환자별로 과거 수납여부 파일 추적

   📌 환자: 홍길동, 현재 미수금: 70만원
   
   • 1월 수납여부: 70만원 (X)
   • 12월 수납여부: 70만원 (X)
   • 11월 수납여부: 70만원 (X)
   
   ➡️ 3개월 누적 미수금

3. 전체 미수금을 월별로 분류
   • M (1월 발생): 80만원
   • M-1 (12월부터): 10만원
   • M-2 (11월부터): 5만원
   • M-3 (10월부터): 5만원
```

#### 출력 형식

```
미수금 Aging
─────────────────────────
총액     M     M-1   M-2   M-3
100만원  80만  10만  5만   5만
```

---

### 3.3 금일 수납액 Aging

**목적:** 어제 수납된 돈이 몇 달 전 미수금인지 확인

#### 계산 로직

```
1. 어제 결제한 각 환자의 발생월 확인 (3.1 로직 사용)

2. 발생월별로 금액 분류

   📌 홍길동: 140만원 결제
   • 12월분: 70만원
   • 11월분: 70만원
   
   📌 김철수: 70만원 결제
   • 1월분: 70만원

3. 전체 합산
   • M (1월분): 70만원
   • M-1 (12월분): 70만원
   • M-2 (11월분): 70만원
   • M-3: 0원
```

#### 의미 해석

| 지표 | 의미 |
|------|------|
| **M-2, M-1 금액이 크면** | 오래된 미수금이 회수됨 |
| **M 금액이 크면** | 당월분을 빠르게 수납함 |
| **M+1 있으면** | 다음 달 선납 |

#### 출력 형식

```
금일 수납액 Aging (전일 기준)
─────────────────────────────
총액     M-3   M-2   M-1    M   M+1
210만원  0만   70만  70만  70만  0만
```

---

## 4. 원무일보 최종 구조

### 전체 구성

```
┌──────────────────────────────────────┐
│         원무일보                      │
│    기준일: YYYY-MM-DD (전일)          │
├──────────────────────────────────────┤
│ 1. 입원수입                           │
│    • 환자별 발생월, 결제수단, 금액    │
│    • 합계 (신용카드, 계좌입금, 현금)  │
│    • 특이사항 (수동 입력란)           │
├──────────────────────────────────────┤
│ 2. 외래수입                           │
│    • 성명, 발생월, 진료일자,          │
│      계(외래수입)                     │
│    • 합계                             │
│    • 특이사항 (수동 입력란)           │
├──────────────────────────────────────┤
│ 3. 금액별 수납보고                    │
│    • 당월 매출 총액                   │
│      (이번 달 청구 예정 총액)         │
│    • 당월 수납 총액                   │
│      (이번 달 누적 수납액)            │
│    • 수납 총액 파이차트               │
│      (수납률 = 당월수납/당월매출)     │
│    • 미수금 Aging                     │
│      (M, M-1, M-2, M-3 분류)          │
│    • 금일 수납액 Aging                │
│      (발생월별 분류)                  │
└──────────────────────────────────────┘
```

### 4.1 입원수입 테이블

| 성명 | 발생월 | 내역 | 입원수입 | 신용카드 | 계좌입금 | 현금 | 계 |
|------|--------|------|----------|----------|----------|------|-----|
| 김영호 | 10월 | 10월 입원 | 700,320 | 700,320 | 0 | 0 | 700,320 |
| 지윤희 | 10월,11월 | 10월,11월 입원 | 1,150,470 | 1,150,470 | 0 | 0 | 1,150,470 |
| **합계** | - | - | - | **5,213,880** | **5,936,620** | **1,286,770** | **12,437,270** |

**특이사항:** (수동 입력란)

---

### 4.2 외래수입 테이블

| 성명 | 발생월 | 진료일자 | 계(외래수입) |
|------|--------|----------|--------------|
| 한규영 | 11월 | 2025-11-11 | 4,300 |
| 김민수 | 11월 | 2025-11-11 | 0 |
| **합계** | - | - | **150,900** |

**특이사항:** (수동 입력란)

---

### 4.3 금액별 수납보고

#### A. 당월 매출 총액

```
이번 달 수납여부 파일의 "수납액" 컬럼 합계
= 이번 달 청구 예정 총액

예시: 253명 × 수납액 합계 = 242,986,270원
```

#### B. 당월 수납 총액

```
이번 달 1일 ~ 어제까지 누적 수납액
= 닥터스 데이터에서 "수납일자가 이번 달"인 입금총액/받은금액 합계

예시: 1월 1일~1월 4일 누적 = 50,000,000원
```

#### C. 수납 총액 파이차트

```
수납률 = (당월 수납 총액 / 당월 매출 총액) × 100%

예시:
• 매출 총액: 242,986,270원
• 수납 총액: 50,000,000원
• 수납률: 20.6%

📊 파이차트: 구글 시트 차트 기능 활용
```

#### D. 미수금 Aging

| 구분 | 총액 | M | M-1 | M-2 | M-3 |
|------|------|---|-----|-----|-----|
| 미수금 | 100만원 | 80만원 | 10만원 | 5만원 | 5만원 |

#### E. 금일 수납액 Aging

| 구분 | 총액 | M-3 | M-2 | M-1 | M | M+1 |
|------|------|-----|-----|-----|---|-----|
| 금일 수납액 | 210만원 | 0만원 | 70만원 | 70만원 | 70만원 | 0만원 |

---

## 5. 필요한 준비사항

### 5.1 구글 드라이브 폴더 구조

```
📁 병원자동화/
  📁 닥터스데이터/
    📄 닥터스_입원_YYYY-MM-DD.xlsx (매일 수동 업로드)
    📄 닥터스_외래_YYYY-MM-DD.xlsx (매일 수동 업로드)
  📁 수납여부/
    📊 수납여부_2024년08월
    📊 수납여부_2024년09월
    📊 수납여부_2024년10월
    📊 수납여부_2024년11월
    📊 수납여부_2024년12월
    📊 수납여부_2025년01월 (자동 생성)
  📁 원무일보/
    📊 원무일보_2025-01-04 (자동 생성)
    📊 원무일보_2025-01-05 (자동 생성)
```

### 5.2 파일명 규칙

| 파일 종류 | 파일명 규칙 | 예시 |
|-----------|-------------|------|
| 닥터스 입원 데이터 | `닥터스_입원_YYYY-MM-DD.xlsx` | 닥터스_입원_2025-01-04.xlsx |
| 닥터스 외래 데이터 | `닥터스_외래_YYYY-MM-DD.xlsx` | 닥터스_외래_2025-01-04.xlsx |
| 수납여부 | `수납여부_YYYY년MM월` | 수납여부_2025년01월 |
| 원무일보 | `원무일보_YYYY-MM-DD` | 원무일보_2025-01-04 |

### 5.3 기존 데이터 준비

월초 첫 실행 전에:

1. **최근 6개월 수납여부 파일** 구글 드라이브에 업로드
   - 발생월 판단에 필요
   - 파일명 규칙 준수

2. **닥터스 입원/외래 데이터 (월말 버전)** 업로드
   - 첫 수납여부 생성용

### 5.4 n8n 설정

- **구글 계정 연동:** 드라이브, 시트 접근 권한
- **실행 환경:** 로컬 PC (항상 켜져 있어야 함) or 클라우드
- **스케줄:**
  - 월초: 매월 1일 오전 9시
  - 매일: 오후 2시

---

## 6. 예상 노드 구성 및 복잡도

### 6.1 워크플로우별 노드 수

| 워크플로우 | 예상 노드 수 | 복잡도 |
|------------|--------------|--------|
| 수납여부 생성 | ~20개 | 중간 |
| 일일보고서 생성 | ~40개 | 복잡 |
| **총계** | **~60개** | **복잡** |

### 6.2 복잡도 요인

- ⚠️ 다중 파일 읽기 (입원/외래 데이터, 최근 6개월 수납여부)
- ⚠️ 복잡한 발생월 매칭 로직
- ⚠️ Aging 분석 계산
- ⚠️ 구글 시트 차트 생성

### 6.3 주요 노드 구성

#### A. 수납여부 생성 워크플로우 (~20개 노드)

```
[Schedule Trigger] 매월 1일 9시
    ↓
[Google Drive] 닥터스 입원 데이터 읽기
    ↓
[Google Drive] 닥터스 외래 데이터 읽기
    ↓
[Spreadsheet File] 엑셀 파싱 (입원)
    ↓
[Spreadsheet File] 엑셀 파싱 (외래)
    ↓
[Google Sheets] 전월 수납여부 읽기
    ↓
[Code] 미수금 환자 필터링 + 대조
    ↓
[Code] 환자별 집계
    ↓
[Google Sheets] 수납여부 시트 생성
    ↓
[Code] 통계 계산 및 추가
```

#### B. 일일보고서 생성 워크플로우 (~40개 노드)

```
[Schedule Trigger] 매일 14시
    ↓
[Google Drive] 닥터스 입원/외래 데이터 읽기 (2개)
    ↓
[Spreadsheet File] 엑셀 파싱 (2개)
    ↓
[Code] 전일 결제 필터링
    ↓
[Google Sheets] 과거 수납여부 파일 읽기 (6개월 = 6개 노드)
    ↓
[Code] 발생월 판단 (금액 매칭 로직)
    ↓
[Code] 입원수입 테이블 생성
    ↓
[Code] 외래수입 테이블 생성
    ↓
[Code] 금액별 수납보고 계산
    - 당월 매출/수납 총액
    - 미수금 Aging
    - 금일 수납액 Aging
    ↓
[Google Sheets] 원무일보 시트 생성 (3개 시트)
    - 입원수입
    - 외래수입
    - 금액별 수납보고
    ↓
[Google Sheets] 이번 달 수납여부 읽기
    ↓
[Code] 수납여부 업데이트 데이터 생성
    ↓
[Google Sheets] 수납여부 시트 업데이트
```

---

## 7. 단계별 구현 계획

### 7.1 구현 일정

| 단계 | 구현 내용 | 소요 기간 |
|------|-----------|-----------|
| **Phase 1** | **기본 자동화** | **2주** |
| | • 수납여부 생성 (전월 대조) | |
| | • 입원/외래수입 테이블 생성 | |
| | • 수납여부 업데이트 | |
| **Phase 2** | **금액별 수납보고** | **1.5주** |
| | • 당월 매출/수납 총액 계산 | |
| | • 미수금 Aging 로직 | |
| | • 금일 수납액 Aging 로직 | |
| | • 파이차트 생성 | |
| **Phase 3** | **보완 및 최적화** | **0.5주** |
| | • 에러 핸들링 강화 | |
| | • 사용 가이드 작성 | |
| | • 테스트 및 검증 | |
| **총계** | | **4주** |

### 7.2 단계별 산출물

#### Phase 1 산출물
- ✅ 수납여부 생성 워크플로우
- ✅ 일일보고서 기본 워크플로우
- ✅ 테스트 결과

#### Phase 2 산출물
- ✅ 발생월 자동 판단 기능
- ✅ Aging 분석 기능
- ✅ 매칭 정확도 리포트

#### Phase 3 산출물
- ✅ 최종 워크플로우
- ✅ 사용 가이드 문서
- ✅ 에러 처리 매뉴얼

---

## 8. 예상 비용

### 8.1 비용 구성

| 항목 | 금액 |
|------|------|
| 수납여부 생성 워크플로우 (노드 20개) | 10~30만원 |
| 일일보고서 생성 워크플로우 (노드 40개) | 30만원 이상 |
| **총 예상 비용** | **50~80만원** |

### 8.2 포함 사항

- ✅ Phase 1~3 전체 구현
- ✅ Aging 분석 포함
- ✅ 테스트 및 수정
- ✅ 간단한 사용 가이드 제공

### 8.3 제외 사항

- ❌ n8n 호스팅 비용 (로컬 PC 사용 시 무료)
- ❌ 구글 워크스페이스 비용
- ❌ 유지보수 (별도 계약)

---

## 9. 예상 리스크 및 대응 방안

### 9.1 리스크 관리 표

| 리스크 | 원인 | 대응 방안 |
|--------|------|-----------|
| **Aging 계산 정확도** | • 과거 파일 누락<br>• 이름 불일치 | • 필수 파일 체크<br>• 차트번호로 재시도<br>• 실패 환자 표시 |
| **발생월 추정 오류** | • 금액 불일치<br>• 특수 케이스 | • 가까운 조합 선택<br>• 차이 플래그 표시<br>• 수동 확인 유도 |
| **파일명 규칙 불일치** | • 파일명 오타<br>• 형식 불일치 | • 규칙 문서화<br>• 검증 로직 추가<br>• 에러 알림 |
| **데이터 누락** | • 업로드 누락<br>• 데이터 오류 | • 파일 존재 체크<br>• 알림 발송<br>• 수동 실행 옵션 |

### 9.2 리스크 완화 전략

#### 사전 예방
- 파일명 규칙 문서 제공
- 필수 파일 체크리스트
- 업로드 가이드 작성

#### 실시간 대응
- 에러 발생 시 즉시 알림
- 실패 환자 별도 표시
- 수동 보정 기능 제공

#### 사후 관리
- 로그 기록 및 분석
- 주간 리포트 생성
- 개선사항 반영

---

## 10. 다음 단계

### 10.1 기획안 승인 후

1. **구현 가이드 작성** (노드별 세부 설정)
2. **개발 환경 설정** (n8n 설치, 구글 연동)
3. **Phase 1 구현 시작**

### 10.2 고객 준비 사항

- ✅ 구글 드라이브 폴더 구조 생성
- ✅ 최근 6개월 수납여부 파일 업로드
- ✅ 월말 닥터스 데이터 (입원/외래) 업로드
- ✅ n8n 실행 환경 결정 (로컬 PC or 클라우드)

### 10.3 첫 미팅 안건

1. 기획안 검토 및 피드백
2. 구현 우선순위 조정
3. 일정 확정
4. 준비사항 체크

---

## 📞 문의 및 연락

기획안에 대한 문의사항이나 추가 논의가 필요하신 경우 언제든지 연락 주시기 바랍니다.

**감사합니다.**

---

> 💡 이 문서는 요양병원 수납 업무 자동화를 위한 n8n 워크플로우 기획안입니다.  
> 실제 구현 시 세부 사항은 고객 요구사항에 따라 조정될 수 있습니다.
